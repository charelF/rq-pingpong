<!DOCTYPE html>
<html>

<head>
    <title>Game Results</title>
    <style>
        table,
        th,
        td {
            border: 1px solid black;
            border-collapse: collapse;
            padding: 3px;
        }

        body {
            background-color: #faa634;
        }
        p, label, table, th, td, h1 {
            font-family: Helvetica, Arial, sans-serif;
            font-size: 16px;
            font-weight: medium;
            color: black;
        }
    </style>
</head>

<body>
    <h1>üèì RiskQuest Ping Pong üèì</h1>

    <form id="gameForm">
        <label for="winner">Winner:</label>
        <select id="winner" name="winner" required>
            <option hidden disabled selected value></option>
            <select id="loser" name="loser" required>
        </select>
        <br>

        <label for="loser">Loser:</label>
        <select id="loser" name="loser" required>
            <option hidden disabled selected value></option>
        </select>
        <br>

        <input type="submit" value="Submit">
    </form>
    <br>

    <h1>ELO rankings</h1>
    <table id="eloTable">
        <thead>
            <tr>
                <th>Username</th>
                <th>ELO</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <br>
    
    <h1>Recent games</h1>
    <table id="gameTable">
        <thead>
            <tr>
                <th>Winner</th>
                <th>Loser</th>
                <th>Time</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <br>

    <h1>Create a new user</h1>
    <form id="userForm">
        <label for="username">Username:</label>
        <input type="text" id="username" name="username"><br>
        <input type="submit" value="Submit">
    </form>

    <script>
        // Function to fetch user data and populate select boxes
        async function populateUserOptions() {
            const usersResponse = await fetch('/api/v1/users');
            const usersData = await usersResponse.json();
            
            const winnerSelect = document.getElementById('winner');
            const loserSelect = document.getElementById('loser');
            
            usersData.forEach(user => {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = user.username;
                winnerSelect.appendChild(option);
                loserSelect.appendChild(option.cloneNode(true));
            });
        }

        // Call the function to populate the select boxes when the page loads
        populateUserOptions();

        // Function to fetch data from the API and populate the table
        async function fetchGameData() {
            const response = await fetch('/api/v1/games?limit=3');
            const data = await response.json();
            const tableBody = document.querySelector('#gameTable tbody');
            data.forEach(game => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = game.winner;
                row.insertCell(1).textContent = game.loser;
                row.insertCell(2).textContent = game.dt;
            });
        }
        fetchGameData();

        // Function to fetch data from the API and populate the table
        async function fetchELO() {
            const response = await fetch('/elo');
            const data = await response.json();
            const tableBody = document.querySelector('#eloTable tbody');
            data.forEach(entry => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = entry.username;
                row.insertCell(1).textContent = entry.score;
            });
        }
        fetchELO();

        document.getElementById('gameForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission
            const formData = new FormData(this);
            fetch('/api/v1/games', {
                method: 'POST',
                body: JSON.stringify({
                    winner: formData.get('winner'),
                    loser: formData.get('loser')
                }),
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (response.ok) {
                    alert('Game result submitted successfully. Refresh the page to see the game int the list');
                } else {
                    alert('Failed to submit game result: {response}');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });

        document.getElementById('userForm').addEventListener('submit', function(event) {
            event.preventDefault(); // Prevent the default form submission
            const formData = new FormData(this);
            const username = formData.get('username')
            fetch(`/api/v1/users/${username}`, {method: 'POST'})
            .then(response => {
                if (response.ok) {
                    alert('New user added succesfully. Refresh the page to see the username in the dropdown.');
                } else {
                    alert('Failed to create new user');
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });


        
    </script>
</body>

</html>